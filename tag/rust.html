<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>y.tsutsumi.io - rust</title>
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="y.tsutsumi.io Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">y.tsutsumi.io </a></h1>
                <nav><ul>
                    <li><a href="/category/programming.html">Just Programming Posts</a></li>
                    <li><a href="/codersguide/">Coder's Guide</a></li>
                    <li><a href="https://nbviewer.jupyter.org/github/toumorokoshi/notebooks/tree/master/">Notebooks</a></li>
                    <li><a href="./pages/about-me.html">About Me</a></li>
                    <li><a href="./pages/projects.html">Projects</a></li>
                    <li><a href="./pages/resources.html">Resources</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="./using-rust-functions-in-llvms-jit.html">Using Rust functions in LLVM's JIT</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-09-30T00:00:00+02:00">
                Published: Sun 30 September 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/yusuke-tsutsumi.html">Yusuke Tsutsumi</a>
        </address>
<p>In <a href="./category/programming.html">programming</a>.</p>
<p>tags: <a href="./tag/rust.html">rust</a> </p>
</footer><!-- /.post-info --><p><a class="reference external" href="http://llvm.org/">LLVM</a> is an amazing framework for building high-performance programming languages,
and Rust has some great bindings with <a class="reference external" href="https://crates.io/crates/llvm-sys">llvm-sys</a>. One challenge
was getting functions authored in Rust exposed to LLVM. To make this happen, there's a few steps to walk through.</p>
<div class="section" id="exposing-the-rust-functions-as-c-externs">
<h2>1. Exposing the Rust functions as C externs</h2>
<p>When LLVM interfaces with shared libraries, it uses the C ABI protocol to do so. Rust provides a way to build do this, out of the box, using the 'extern &quot;C&quot;' declaration:</p>
<div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>This instructs the Rust compiler that this should be exposed in a way where it can be found and used as a library. In the case of an executable binary, this is still the case.</p>
<p>The big gotcha here is ensuring that you are declaring the function as public, AND you are declaring it as public in the main module too. If the function was located in a child module, you will need to re-export in the main file:</p>
<div class="highlight"><pre><span></span><span class="c1">// src/my_mod.rs</span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;I&#39;m a shared library call&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// main.rs</span>
<span class="k">mod</span> <span class="nn">my_mod</span><span class="w"></span>
<span class="c1">// note the pub here.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span>::<span class="n">my_mod</span>::<span class="n">foo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>There are <a href="./using-rust-functions-in-llvms-jit.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/toumorokoshi">GitHub</a></li>
                            <li><a href="https://twitter.com/tsutsumiyusuke">Twitter</a></li>
                            <li><a href="http://www.linkedin.com/profile/view?id=56043626">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-29270527-2', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'tsutsumi';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>