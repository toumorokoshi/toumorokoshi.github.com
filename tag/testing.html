<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>y.tsutsumi.io - testing</title>
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="y.tsutsumi.io Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">y.tsutsumi.io </a></h1>
                <nav><ul>
                    <li><a href="/category/programming.html">Just Programming Posts</a></li>
                    <li><a href="/codersguide/">Coder's Guide</a></li>
                    <li><a href="https://nbviewer.jupyter.org/github/toumorokoshi/notebooks/tree/master/">Notebooks</a></li>
                    <li><a href="./pages/about-me.html">About Me</a></li>
                    <li><a href="./pages/projects.html">Projects</a></li>
                    <li><a href="./pages/resources.html">Resources</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="./test-classes-dont-work.html">Test Classes Don't Work</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-09-01T00:00:00+02:00">
                Published: Tue 01 September 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/yusuke-tsutsumi.html">Yusuke Tsutsumi</a>
        </address>
<p>In <a href="./category/programming.html">programming</a>.</p>
<p>tags: <a href="./tag/testing.html">testing</a> </p>
</footer><!-- /.post-info --><p>Test Classes don't work as a test structure.</p>
<p>It's worth clarifying what I mean by the test class. I'm
speaking specifically about the following structure of an test:</p>
<ul class="simple">
<li>having a test class, that contains the setup and teardown method for test fixtures</li>
<li>putting multiple tests in that class</li>
<li>having the execution of a test look something like:
* run setup
* execute test
* run teardown</li>
</ul>
<p>More or less, something like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestMyStuff</span><span class="p">:</span>

     <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">fixture_one</span> <span class="o">=</span> <span class="n">create_fixture</span><span class="p">()</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">fixture_two</span> <span class="o">=</span> <span class="n">create_another_fixture</span><span class="p">()</span>

     <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_one</span><span class="p">)</span>
         <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_two</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">test_my_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">something</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_one</span><span class="p">)</span>
         <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_ok</span>
</pre></div>
<p>This pattern is prevalent across testing suites, since they follow the
<a class="reference external" href="http://www.martinfowler.com/bliki/Xunit.html">XUnit</a> pattern of test design.</p>
<div class="section" id="why-test-classes-are-the-norm">
<h2>Why Test Classes are the Norm</h2>
<p>Removing the setup and teardown from your test fixtures keep things
clean: it makes sense to remove them from you test body. When looking at code,
you only want to look at context that's relevant to you, otherwise it's harder
to identify what should be focused on:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_my_stuff</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">create_fixture</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">something</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_ok</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
</pre></div>
<p>So, it makes sense to have setup and teardown methods. A lot of the
time, you'll have common sets of test fixtures, and you want to share
them without explicitly specifying them every time. Most languages
provide object-oriented programming, which allows state that is
accessible by all methods. Classes are a good vessel to give a test
access to a set of test fixtures.</p>
</div>
<div class="section" id="when-you-have-a-hammer">
<h2>When You Have a Hammer...</h2>
<p>The thing about object oriented programming is, it's almost always a
single inheritance model, and multiple inheritance gets ugly
quickly. It's not very easy to compose test classes together. In the
context of test classes, why would you ever want to do that?</p>
<p>Test fixtures. Tests depend on a variety of objects, and you don't
want to have to multiple the setup of the same test fixtures across
multiple classes. Even when you factor it out, it gets messy quick:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestA</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_a</span> <span class="o">=</span> <span class="n">create_fixture_a</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_a</span><span class="p">)</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">TestB</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_other_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

<span class="k">class</span> <span class="nc">TestB</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_c</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_c</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_other_other_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
<p>At this rate, a test class per test would become necessary, each with
the same code to set up and teardown the exact same fixture.</p>
<p>To avoid this, there needs to be a test system that:</p>
<ul class="simple">
<li>has factories for test fixtures</li>
<li>as little code as possible to choose the fixtures necessary, and to
clean them up.</li>
</ul>
</div>
<div class="section" id="a-better-solution-dependency-injection">
<h2>A Better Solution: Dependency Injection</h2>
<p>In a more general sense, a test fixtures is a dependency for a
test. If a system existed that handled the teardown and creation of
dependencies, it's possible to keep the real unique logic alone
in the test body.</p>
<p>Effectively, this is the exact description of a <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection
framework</a>:
specify the dependencies necessary, and the framework handles the
rest.</p>
<p>For Python as an example, <a class="reference external" href="https://pytest.org/latest/fixture.html">py.test</a> has this capability. I declare a common fixture
somewhere, and can consume it implicitly in any test function:</p>
<div class="highlight"><pre><span></span><span class="c1"># example copied from the py.test fixture page.</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">smtp</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">smtplib</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s2">&quot;merlinux.eu&quot;</span><span class="p">)</span>
    <span class="c1"># addfinalizer can be used to hook into the fixture cleanup process</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">teardown</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_ehlo</span><span class="p">(</span><span class="n">smtp</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="c1"># for demo purposes</span>
</pre></div>
<p>With pytest, You can even use fixtures while generating other fixtures!</p>
<p>It's a beautiful concept, and a cleaner example of how test fixtures
could be handled. No more awkward test class container to handle creation
and teardown of fixtures.</p>
<p>As always, thoughts and comment are appreciated.</p>
</div>
<p>There are <a href="./test-classes-dont-work.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="./how-i-design-test-suites.html" rel="bookmark"
                           title="Permalink to How I Design Test Suites">How I Design Test Suites</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-08-30T00:00:00+02:00">
                Published: Sun 30 August 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/yusuke-tsutsumi.html">Yusuke Tsutsumi</a>
        </address>
<p>In <a href="./category/programming.html">programming</a>.</p>
<p>tags: <a href="./tag/testing.html">testing</a> </p>
</footer><!-- /.post-info -->                <p>At Zillow, I've done a lot of work on the design and development of
the test infrastructure we use for full-stack tests. It's always fun
to watch your tool become popular, but even more interesting is the
discussions around test suite design that come with it.</p>
<p>Many discussions later, I …</p>
                <a class="readmore" href="./how-i-design-test-suites.html">read more</a>
<p>There are <a href="./how-i-design-test-suites.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="./the-dangers-of-patching.html" rel="bookmark"
                           title="Permalink to The Dangers of Patching">The Dangers of Patching</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-08-21T00:00:00+02:00">
                Published: Thu 21 August 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/yusuke-tsutsumi.html">Yusuke Tsutsumi</a>
        </address>
<p>In <a href="./category/programming.html">programming</a>.</p>
<p>tags: <a href="./tag/testing.html">testing</a> <a href="./tag/patch.html">patch</a> <a href="./tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <p>If you've ever used <a class="reference external" href="https://pypi.python.org/pypi/mock">Mock</a> (or
the built-in <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html">mock in python
3</a>), you'll
know how powerful of a tool it can be toward making unit testing on
functions modifying state sane. Mocks in Python are effectively a probe
that you can send into a deep, dark function:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mock</span>

<span class="k">def …</span></pre></div>
                <a class="readmore" href="./the-dangers-of-patching.html">read more</a>
<p>There are <a href="./the-dangers-of-patching.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/toumorokoshi">GitHub</a></li>
                            <li><a href="https://twitter.com/tsutsumiyusuke">Twitter</a></li>
                            <li><a href="http://www.linkedin.com/profile/view?id=56043626">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-29270527-2', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'tsutsumi';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>