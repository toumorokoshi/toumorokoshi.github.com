<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Test Classes Don’t Work | Yusuke Tsutsumi</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Test Classes Don’t Work" />
<meta name="author" content="toumorokoshi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Test Classes don&#39;t work as a test structure." />
<meta property="og:description" content="Test Classes don&#39;t work as a test structure." />
<link rel="canonical" href="https://y.tsutsumi.io/2015/09/01/test-classes-dont-work/" />
<meta property="og:url" content="https://y.tsutsumi.io/2015/09/01/test-classes-dont-work/" />
<meta property="og:site_name" content="Yusuke Tsutsumi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-09-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Test Classes Don’t Work" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"toumorokoshi"},"dateModified":"2015-09-01T00:00:00+00:00","datePublished":"2015-09-01T00:00:00+00:00","description":"Test Classes don&#39;t work as a test structure.","headline":"Test Classes Don’t Work","mainEntityOfPage":{"@type":"WebPage","@id":"https://y.tsutsumi.io/2015/09/01/test-classes-dont-work/"},"url":"https://y.tsutsumi.io/2015/09/01/test-classes-dont-work/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://y.tsutsumi.io/feed/index.xml" title="Yusuke Tsutsumi" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-29270527-2"></script>
<script>
  window['ga-disable-UA-29270527-2'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag() { window.dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-29270527-2');
</script>
</head>
<body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Yusuke Tsutsumi</a><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
                <span class="menu-icon">
                    <svg viewBox="0 0 18 15" width="18px" height="15px">
                        <path
                            d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
                    </svg>
                </span>
            </label>

            <div class="trigger">
                <a class="page-link" href="/tag/coding/">Coding Posts</a>
                <a class="page-link"
                    href="https://nbviewer.jupyter.org/github/toumorokoshi/notebooks/tree/master/">Notebooks</a><a class="page-link" href="/resources/">Resources</a><a class="page-link" href="/about/">About Yusuke Tsutsumi</a></div>
        </nav></div>
    <style>
        .gse-control-cse td {
            border: 0;
        }

        td.gsc-input {
            border: 0;
        }

        td.gsc-search-button {
            border: 0;
        }

        table.gsc-input {
            margin-bottom: 0;
        }
    </style>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">Test Classes Don&#39;t Work</h1>
        <p class="post-meta"><time class="dt-published" datetime="2015-09-01T00:00:00+00:00" itemprop="datePublished">
                Sep 1, 2015
            </time>• 
            <span itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span class="p-author h-card" itemprop="name">toumorokoshi</span></span></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
        <p>Test Classes don't work as a test structure.</p>

<p>It's worth clarifying what I mean by the test class. I'm speaking
specifically about the following structure of an test:</p>

<ul>
  <li>having a test class, that contains the setup and teardown method for
test fixtures</li>
  <li>putting multiple tests in that class</li>
  <li>having the execution of a test look something like:
    <ul>
      <li>run setup</li>
      <li>execute test</li>
      <li>run teardown</li>
    </ul>
  </li>
</ul>

<p>More or less, something like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestMyStuff</span><span class="p">:</span>

     <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">fixture_one</span> <span class="o">=</span> <span class="n">create_fixture</span><span class="p">()</span>
         <span class="bp">self</span><span class="p">.</span><span class="n">fixture_two</span> <span class="o">=</span> <span class="n">create_another_fixture</span><span class="p">()</span>

     <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_one</span><span class="p">)</span>
         <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_two</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">test_my_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">something</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_one</span><span class="p">)</span>
         <span class="k">assert</span> <span class="n">result</span><span class="p">.</span><span class="n">is_ok</span>
</code></pre></div></div>

<p>This pattern is prevalent across testing suites, since they follow the
<a href="http://www.martinfowler.com/bliki/Xunit.html">XUnit</a> pattern of test
design.</p>
                <h2 id="why-test-classes-are-the-norm">   Why Test Classes are the Norm <a href="#why-test-classes-are-the-norm">#</a>   </h2>
                    

<p>Removing the setup and teardown from your test fixtures keep things
clean: it makes sense to remove them from you test body. When looking at
code, you only want to look at context that's relevant to you,
otherwise it's harder to identify what should be focused on:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_my_stuff</span><span class="p">():</span>
    <span class="n">fixture</span> <span class="o">=</span> <span class="n">create_fixture</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">something</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="p">.</span><span class="n">is_ok</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
</code></pre></div></div>

<p>So, it makes sense to have setup and teardown methods. A lot of the
time, you'll have common sets of test fixtures, and you want to share
them without explicitly specifying them every time. Most languages
provide object-oriented programming, which allows state that is
accessible by all methods. Classes are a good vessel to give a test
access to a set of test fixtures.</p>
                <h2 id="when-you-have-a-hammer">   When You Have a Hammer... <a href="#when-you-have-a-hammer">#</a>   </h2>
                    

<p>The thing about object oriented programming is, it's almost always a
single inheritance model, and multiple inheritance gets ugly quickly.
It's not very easy to compose test classes together. In the context of
test classes, why would you ever want to do that?</p>

<p>Test fixtures. Tests depend on a variety of objects, and you don't want
to have to multiple the setup of the same test fixtures across multiple
classes. Even when you factor it out, it gets messy quick:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestA</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fixture_a</span> <span class="o">=</span> <span class="n">create_fixture_a</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_a</span><span class="p">)</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">...</span>


<span class="k">class</span> <span class="nc">TestB</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_other_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">...</span>

<span class="k">class</span> <span class="nc">TestB</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fixture_c</span> <span class="o">=</span> <span class="n">create_fixture_b</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span> <span class="o">=</span> <span class="n">create_fixture_c</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fixture_b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_my_other_other_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">...</span>
</code></pre></div></div>

<p>At this rate, a test class per test would become necessary, each with
the same code to set up and teardown the exact same fixture.</p>

<p>To avoid this, there needs to be a test system that:</p>

<ul>
  <li>has factories for test fixtures</li>
  <li>as little code as possible to choose the fixtures necessary, and to
clean them up.</li>
</ul>
                <h2 id="a-better-solution-dependency-injection">   A Better Solution: Dependency Injection <a href="#a-better-solution-dependency-injection">#</a>   </h2>
                    

<p>In a more general sense, a test fixtures is a dependency for a test. If
a system existed that handled the teardown and creation of dependencies,
it's possible to keep the real unique logic alone in the test body.</p>

<p>Effectively, this is the exact description of a <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection
framework</a>: specify
the dependencies necessary, and the framework handles the rest.</p>

<p>For Python as an example,
<a href="https://pytest.org/latest/fixture.html">py.test</a> has this capability. I
declare a common fixture somewhere, and can consume it implicitly in any
test function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># example copied from the py.test fixture page.
</span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">smtp</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">smtplib</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="p">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s">"merlinux.eu"</span><span class="p">)</span>
    <span class="c1"># addfinalizer can be used to hook into the fixture cleanup process
</span>    <span class="n">request</span><span class="p">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">teardown</span><span class="p">(</span><span class="n">server</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_ehlo</span><span class="p">(</span><span class="n">smtp</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp</span><span class="p">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="c1"># for demo purposes
</span></code></pre></div></div>

<p>With pytest, You can even use fixtures while generating other fixtures!</p>

<p>It's a beautiful concept, and a cleaner example of how test fixtures
could be handled. No more awkward test class container to handle
creation and teardown of fixtures.</p>

<p>As always, thoughts and comment are appreciated.</p>
    </div><a class="u-url" href="/2015/09/01/test-classes-dont-work/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/%20/"></data>

    <div class="wrapper">

        <div class="footer-col-wrapper">
            <script async src="https://cse.google.com/cse.js?cx=014358564571565173111:hnnbq4j54cy"></script>
            <div class="gcse-search"></div>
        </div>
        <div class="footer-col-wrapper">
            <div class="footer-col">
                <p class="feed-subscribe">
                    <a href="/feed/index.xml">
                        <svg class="svg-icon orange">
                            <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
                        </svg><span>Subscribe</span>
                    </a>
                </p>
            </div>
            <div class="footer-col">
                <p>My blog on software, productivity, and obsessively optimizing. I work at Google, ex-Zillow. Thoughts my own.</p>
            </div>
        </div>

        <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/toumorokoshi" target="_blank" title="toumorokoshi"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/yusuke-tsutsumi" target="_blank" title="yusuke-tsutsumi"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/tsutsumiyusuke" target="_blank" title="tsutsumiyusuke"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

    </div>

</footer></body>

</html>
