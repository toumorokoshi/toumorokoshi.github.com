<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>KeyError in self._handlers: a journey deep into Tornado's internals</title>
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="y.tsutsumi.io Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">y.tsutsumi.io </a></h1>
                <nav><ul>
                    <li><a href="/category/programming.html">Just Programming Posts</a></li>
                    <li><a href="/codersguide/">Coder's Guide</a></li>
                    <li><a href="https://nbviewer.jupyter.org/github/toumorokoshi/notebooks/tree/master/">Notebooks</a></li>
                    <li><a href="./pages/about-me.html">About Me</a></li>
                    <li><a href="./pages/projects.html">Projects</a></li>
                    <li><a href="./pages/resources.html">Resources</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./keyerror-in-self_handlers-a-journey-deep-into-tornados-internals.html" rel="bookmark"
           title="Permalink to KeyError in self._handlers: a journey deep into Tornado's internals">KeyError in self._handlers: a journey deep into Tornado's internals</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-27T00:00:00+01:00">
                Published: Fri 27 January 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/yusuke-tsutsumi.html">Yusuke Tsutsumi</a>
        </address>
<p>In <a href="./category/programming.html">programming</a>.</p>
<p>tags: <a href="./tag/python.html">python</a> </p>
</footer><!-- /.post-info -->      <p>If you've worked with tornado, you may have encountered a traceback of
a somewhat bewildering error:</p>
<div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
    <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/site-packages/tornado/ioloop.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">832</span><span class="p">,</span> <span class="ow">in</span> <span class="n">start</span>
<span class="n">fd_obj</span><span class="p">,</span> <span class="n">handler_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span>
<span class="ne">KeyError</span><span class="p">:</span> <span class="mi">16</span>
</pre></div>
<p>A few other people have been confused as well. After some digging and a combination
of learning about the event loop, fork, and epoll, the answer finally entered into focus.</p>
<div class="section" id="tldr">
<h2>TLDR</h2>
<p>If you're looking for the solution, don't call or start IOLoops before
an os.fork. This happens in web servers like gunicorn, as well as
tornado.multiprocess, so be aware of that caveat as well.</p>
</div>
<div class="section" id="but-why-does-this-happen">
<h2>But why does this happen?</h2>
<p>As I mentioned previously, this is a combination of behaviour all
across the system, python and tornado stack. Let's start with
learning more about that error specifically.</p>
<p>The code the traceback is referring occurs in the the IOLoop:</p>
<div class="highlight"><pre><span></span><span class="c1"># tornado/ioloop.py</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">event_pairs</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
    <span class="n">fd</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fd_obj</span><span class="p">,</span> <span class="n">handler_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span>
        <span class="n">handler_func</span><span class="p">(</span><span class="n">fd_obj</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
</pre></div>
<p>What are these variables? you can read the IOLoop code yourself, but effectively:</p>
<ul class="simple">
<li>_handlers is a list of the callbacks that should be called once an async event is complete.</li>
<li>_events is a list of events that have occurred, that need to be handled.</li>
</ul>
<div class="section" id="what-is-an-fd">
<h3>What is an FD?</h3>
<p>The handlers and events are both keyed off of <a class="reference external" href="https://en.wikipedia.org/wiki/File_descriptor">file descriptors</a>. In a
few words, file descriptors represent a handle to some open file. In
unix, a pattern has propagated where a lot of resources (devices,
cgroups, active/inactive state) are referenced via file descriptors:
it became a lingua franca for low level resources because a lot of
tooling knows how to work with file descriptors, and writing and
reading to a file is simple.</p>
<p>They're useful for tornado because sockets also have a file descriptor
represent them. So the tornado ioloop could wait for an event
affecting a socket, then pass that socket to a handler when a socket
event is fired (e.g. some new data came into the socket buffer).</p>
</div>
<div class="section" id="what-modifies-the-events-and-handlers">
<h3>What modifies the events and handlers?</h3>
<p>A KeyError handlers means there's a key in events that is not in the
handlers: some code is causing events to be added to the ioloop, and
aren't registering a handler for it at the same time. So how does that
happen in the code?</p>
<p>A good starting point is looking where _handlers and _events are
modified in the code. In all of the tornado code, there's only a
couple places:</p>
<div class="highlight"><pre><span></span><span class="c1"># tornado/ioloop.py</span>
<span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
    <span class="n">fd</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">stack_context</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">events</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># tornado/ioloop.py</span>
<span class="k">def</span> <span class="nf">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
    <span class="n">fd</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error deleting fd from IOLoop&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>Looking at these pieces, the code is pretty solid:</p>
<ul class="simple">
<li>handlers are added only in add_handler, and they are added to a _impl.register</li>
<li>handlers are only removed in remove_handler, where they are removed in _events, _handlers and _impl.</li>
<li>events are added to _events in _impl.poll()</li>
</ul>
<p>So the removing of handlers always make sure that events no longer has
it anymore, and it removes it from this impl thing too.</p>
<p>But what is impl? Could impl be adding fd's for events that don't have handlers?</p>
</div>
<div class="section" id="impl-polling-objects">
<h3>impl: polling objects</h3>
<p>It turns out _impl is chosen based on the OS. There is a little bit of
indirection here, but the IOLoop class in tornado extends a configurable object,
which selects the class based on the method configurable_default:</p>
<div class="highlight"><pre><span></span><span class="c1"># tornado/ioloop.py</span>
<span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">configurable_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;epoll&quot;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tornado.platform.epoll</span> <span class="kn">import</span> <span class="n">EPollIOLoop</span>
        <span class="k">return</span> <span class="n">EPollIOLoop</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;kqueue&quot;</span><span class="p">):</span>
        <span class="c1"># Python 2.6+ on BSD or Mac</span>
        <span class="kn">from</span> <span class="nn">tornado.platform.kqueue</span> <span class="kn">import</span> <span class="n">KQueueIOLoop</span>
        <span class="k">return</span> <span class="n">KQueueIOLoop</span>
    <span class="kn">from</span> <span class="nn">tornado.platform.select</span> <span class="kn">import</span> <span class="n">SelectIOLoop</span>
    <span class="k">return</span> <span class="n">SelectIOLoop</span>
</pre></div>
<p>And each of these loop implementations pass it's own argument into the impl argument:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EPollIOLoop</span><span class="p">(</span><span class="n">PollIOLoop</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EPollIOLoop</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">impl</span><span class="o">=</span><span class="n">select</span><span class="o">.</span><span class="n">epoll</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>Looking at select.epoll, it follows the interface of a <a class="reference external" href="https://docs.python.org/2/library/select.html#polling-objects">polling object</a>: a
class in the Python standard library that has the ability to poll for
changes to file descriptors. If something happens to a file descriptor
(e.g. a socket recieving data), the polling object, it will return
back the file descriptor that was triggered.</p>
<p>Different architectures have different polling objects
implemented. The avaialable ones in tornado by default are:</p>
<ul class="simple">
<li>epoll (Linux)</li>
<li>kqueue (OSX / BSD)</li>
<li>select Windows use</li>
</ul>
<p>In our case, this was happening on Linux, so we'll look at epoll.</p>
</div>
<div class="section" id="epoll">
<h3>epoll</h3>
<p>So what is epoll? It's documented in the <a class="reference external" href="https://docs.python.org/3/library/select.html#epoll-objects">Python standard library</a>, but
it's a wrapper around the <a class="reference external" href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a> Linux system calls.</p>
<p>The ioloop code actually looks like:</p>
<ul class="simple">
<li>wait for epoll to return a file descriptor that has an event</li>
<li>execute the handler (which will presumably register another handler if another step is required, or not if it's complete)</li>
<li>repeat.</li>
</ul>
<p>epoll has two different configurations, but the one tornado uses is
edge-polling: it only triggers when a CHANGE occurs, vs when a
specific level is hit. In other words, it will only trigger when new
data is available: if the user decides to do nothing with the data,
epoll will not trigger again.</p>
<p>epoll works by registering file descriptors for the epoll object to
listen to. You can also stop listening to file descriptors as well.</p>
<p>So epoll works great for an event loop. But is it possible to somehow
register file descriptors to the epoll/impl object without using the
method above?</p>
</div>
<div class="section" id="epoll-and-os-fork">
<h3>epoll and os.fork</h3>
<p>It isn't possible to register things outside of the impl
object. But, os.fork can cause some weird behaviour here. See, the way
that one interfaces with epoll is using file descriptors: you have an
fd to the epoll object, and you can use Linux system calls to work
with that:</p>
<p>As mentioned previously, file descriptors is a common way to reference
some object when using Linux kernel system calls.</p>
<p>Another common system call is <a class="reference external" href="http://man7.org/linux/man-pages/man2/fork.2.html">fork</a>. The
documentation of fork specifies that fork is equivalent to:</p>
<ul class="simple">
<li>copying the memory of the current process to a new space</li>
<li>spawning a new process that uses the new copy.</li>
</ul>
<p>This is fine for most objects in memory, but how about file
descriptors, which reference some object outside of the memory space
of the current process.</p>
<p>In the case of file descriptors, the file descriptor is also cloned to
the new fork. In other words, both the parent and the child process
will have a reference to the same file descriptor.</p>
<p>So, what does this mean for epoll, which is just another file
descriptor under the hood? Well, you can probably guess.</p>
<p>It gets shared.</p>
</div>
<div class="section" id="how-the-bug-works">
<h3>How the bug works</h3>
<p>So this is the crux of the issue. When an os.fork occurs, the parent
and the child share the SAME epoll. So for an IOLoop that is created
by the parent object, the child process uses the same epoll as well!</p>
<p>So, that allows a condition like this:</p>
<ol class="arabic simple">
<li>parent creates an IOLoop loop_1, with an epoll epoll_1</li>
<li>parent calls os.fork, creating loop_2, which shares the same epoll_2</li>
<li>parent starts ioloop, waits for epoll_1.poll()</li>
<li>child adds a handler for fd_2 to epoll_1</li>
<li>parent gets back fd_2, but doesn't have a handler for it, and raises the KeyError.</li>
</ol>
<p>So this will pretty much happen at some point anytime a new ioloop is not created for a child process.</p>
<p>Here's a repro script. I couldn't figure out a good way to kill this
gracefully, so be warned this will need to be killed externally.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="n">serversocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">))</span>
<span class="n">serversocket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">():</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">serversocket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">handler</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">))</span>
    <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="how-about-gunicorn-or-tornado-multiprocess">
<h3>How about gunicorn or tornado.multiprocess?</h3>
<p>So how to avoid this in gunicorn or tornado.multiprocess, which uses
an os.fork? The best practice is to not start the ioloop until AFTER
the fork: calling ioloop.Instance() or current() will create an ioloop whose ioloop will be shared
by any child ioloop, without explicitly clearing it.</p>
<p>Gunicorn calls a fork as it's spawning a worker:</p>
<div class="highlight"><pre><span></span><span class="c1"># gunicorn/arbiter.py</span>
<span class="k">def</span> <span class="nf">spawn_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">worker_age</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_age</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LISTENERS</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">pre_fork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span>
        <span class="k">return</span> <span class="n">pid</span>
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>Tornado is an awesome framework, but it's not simple. However, thanks
to well documented pieces, it's possible to diagnose even complex
issues like this, and do a bit of learning along the way.</p>
<p>Also, os.fork is not a complete guarantee that you'll get a unique
instance of every object you use. Beware file descriptors.</p>
</div>

    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'tsutsumi';
        var disqus_identifier = 'keyerror-in-self_handlers-a-journey-deep-into-tornados-internals.html';
        var disqus_url = './keyerror-in-self_handlers-a-journey-deep-into-tornados-internals.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//tsutsumi.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://y.tsutsumi.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/toumorokoshi">GitHub</a></li>
                            <li><a href="https://twitter.com/tsutsumiyusuke">Twitter</a></li>
                            <li><a href="http://www.linkedin.com/profile/view?id=56043626">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-29270527-2', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'tsutsumi';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>